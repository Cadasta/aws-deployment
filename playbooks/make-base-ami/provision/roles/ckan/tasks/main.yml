- name: Install base CKAN OS package dependencies
  become: yes
  become_user: root
  apt: pkg={{ item }} state=installed update_cache=yes
  with_items:
    - python-dev
    - postgresql
    - libpq-dev
    - python-pip
    - python-virtualenv
    - git-core
    - solr-jetty
    - openjdk-6-jdk

- name: Create CKAN user
  become: yes
  become_user: root
  user: name=ckan

- name: Create base CKAN directory
  become: yes
  become_user: root
  file: path={{ ckan_base }} state=directory owner=ckan

- name: Install base CKAN source
  become: yes
  become_user: ckan
  pip: name='git+https://github.com/ckan/ckan.git@ckan-2.4.1#egg=ckan'
       virtualenv={{ ckan_base }}

- name: Install base CKAN Python dependencies
  become: yes
  become_user: ckan
  pip: requirements="{{ ckan_base }}/src/ckan/requirements.txt"
       virtualenv={{ ckan_base }}

- name: Create /etc/ckan/default
  become: yes
  become_user: root
  file: path=/etc/ckan/default state=directory

- name: Link who.ini file
  become: yes
  become_user: root
  file: path=/etc/ckan/default/who.ini
        src="{{ ckan_base }}/src/ckan/who.ini"
        state=link

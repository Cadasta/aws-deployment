# AWS deployment scripts for Cadasta platform v1

This comes in four parts:

1. An Ansible playbook to set up the base "fixed" parts of the
   installation (i.e. operating system package installation, etc.),
   using Vagrant for debugging and then, once it's working correctly,
   an EC2 instance to generate an Amazon Machine Image for later
   deployment.

2. An Ansible playbook to extend the base AMI to include the "fixed
   platform-specific" parts of the installation (source code
   installation, fixed configuration, etc.) to create a "deployment
   AMI" (again using Vagrant for debugging, starting from a Vagrant
   box generated from step #1).

3. A script to collect deployment details for a new platform instance.

4. An Ansible playbook to perform the configuration and deployment
   steps for the platform, based on per-instance information collected
   in step #2.  This playbook can deploy either into Vagrant (using a
   Vagrant box generated from step #2) or onto an AWS EC2 instance
   (using the AMI generated from step #2).

The AMIs generated by these processes are registered in a
`machine-images.csv` file since they are AWS region-specific.  The
easiest way to do a deployment in a new region is simply to copy the
deployment AMI from an existing region using the AWS console or
command line and then to add an appropriate line to the
`machine-images.csv` file.

All AWS steps will use the usual AWS configuration environment
variables to control access and region settings.  The simplest
approach is to set up a credentials profile using `aws configure` and
to set the `AWS_PROFILE` environment variable.


### Base AMI generation

The base AMI is built from the standard Ubuntu 14.04 LTS AMI for the
region being used and contains all of the operating system and
"external" software packages needed to support the Cadasta platform
code.  The base AMI should not need to be changed for code changes to
the Cadasta platform unless package dependencies change.

```
cd base-ami-setup
ansible-playbook --private-key=~/.ssh/cadasta-utility.pem make-base-ami.yml
```


### Deployment AMI generation

The deployment AMI is built from the base AMI and contains all of the
Cadasta platform-specific software (i.e. source cloned from Cadasta
repositories) as well as fixed configuration settings that are
independent of the particular deployment.

```
cd deployment-ami-setup
ansible-playbook --private-key=~/.ssh/cadasta-utility.pem make-deployment-ami.yml
```



#### Installation steps

These are the Ansible roles in this playbook:

1. `ckan`: Install base CKAN and prerequisites.
2. `solr`: Install and configure Solr.
3. `ckan_extension`: Install CKAN extension.
4. `angular`: Install Angular application prerequisites.
5. `api`: Install database and API code and prerequisites.
6. `ona`: Install and configure ONA.
7. `prereqs`: Install and configure deployment prerequisites.
